# ููุทู ุงูุญุฌุฒ ูู ุงูุบุฑู (Room Booking Logic)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุญุฌุฒ ูู ุงูุบุฑู ูุนุชูุฏ ุนูู **ุฅุฌูุงูู ุงููุญุฏุงุช** ู**ุงููุญุฏุงุช ุงููุชุงุญุฉ** ูุน ุญุณุงุจ ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ ูู ุงูููุช ุงููุนูู.

---

## ๐๏ธ ูููู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ูููุฐุฌ Room (backend/models/Room.js)

```javascript
availability: {
  isActive: Boolean,        // ูู ุงูุบุฑูุฉ ูุดุทุฉ ููุญุฌุฒุ
  totalRooms: Number,      // ุฅุฌูุงูู ุนุฏุฏ ุงูุบุฑู ูู ูุฐุง ุงูููุน (ูุซูุงู: 10 ุบุฑู)
  availableRooms: Number,  // ุนุฏุฏ ุงูุบุฑู ุงููุชุงุญุฉ ุญุงููุงู (ูุซูุงู: 7 ุบุฑู)
  // ... ุฅุนุฏุงุฏุงุช ุฃุฎุฑู
}
```

**ูุซุงู:**
- `totalRooms: 10` โ ุฅุฌูุงูู 10 ุบุฑู ูู ูุฐุง ุงูููุน
- `availableRooms: 7` โ 7 ุบุฑู ูุชุงุญุฉ ุญุงููุงู (3 ูุญุฌูุฒุฉ)

---

## ๐ ููุทู ุงูุญุฌุฒ (Backend Logic)

### 1. ุนูุฏ ุฅูุดุงุก ุญุฌุฒ ุฌุฏูุฏ (`createRoomBooking`)

**ุงููููุน:** `backend/controllers/roomBookingController.js` - ุงูุณุทุฑ 7-134

#### ุงูุฎุทูุงุช:

**ุฃ) ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ:**
```javascript
- ุงูุชุญูู ูู ูุฌูุฏ ุงูููุฏู ูุงูุบุฑูุฉ
- ุงูุชุญูู ูู ุฃู ุงูุบุฑูุฉ ุชุงุจุนุฉ ููููุฏู
```

**ุจ) ุญุณุงุจ ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ (Conflicting Bookings):**
```javascript
// ุงูุจุญุซ ุนู ุงูุญุฌูุฒุงุช ุงููุคูุฏุฉ ุฃู ุงููุณุฌูุฉ ูู ููุณ ุงููุชุฑุฉ
const conflictingBookings = await RoomBooking.find({
  room: roomId,
  status: { $in: ['confirmed', 'checked_in'] },
  $or: [{
    'bookingDetails.checkIn': { $lt: checkOutDate },
    'bookingDetails.checkOut': { $gt: checkInDate }
  }]
});

// ุญุณุงุจ ุฅุฌูุงูู ุงูุบุฑู ุงููุญุฌูุฒุฉ ูู ูุฐู ุงููุชุฑุฉ
const bookedRooms = conflictingBookings.reduce((total, booking) => {
  return total + booking.bookingDetails.roomCount;
}, 0);
```

**ูุซุงู:**
- ุฅุฐุง ูุงู ูุฏูู 3 ุญุฌูุฒุงุช ูู ููุณ ุงููุชุฑุฉ:
  - ุญุฌุฒ 1: `roomCount: 2`
  - ุญุฌุฒ 2: `roomCount: 1`
  - ุญุฌุฒ 3: `roomCount: 1`
- `bookedRooms = 2 + 1 + 1 = 4`

**ุฌ) ุญุณุงุจ ุงููุญุฏุงุช ุงููุชุงุญุฉ ุงููุนููุฉ:**
```javascript
const availableRooms = roomExists.availability.availableRooms - bookedRooms;
```

**ูุซุงู:**
- `availableRooms` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช = 7
- `bookedRooms` (ูู ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ) = 4
- **ุงููุญุฏุงุช ุงููุชุงุญุฉ ุงููุนููุฉ = 7 - 4 = 3**

**ุฏ) ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุญุฌุฒ:**
```javascript
if (availableRooms < roomCount) {
  return res.status(400).json({
    success: false,
    message: 'ุงูุบุฑูุฉ ุบูุฑ ูุชุงุญุฉ ุจุงูุนุฏุฏ ุงููุทููุจ'
  });
}
```

**ูู) ุจุนุฏ ูุฌุงุญ ุงูุญุฌุฒ - ุชุญุฏูุซ ุงูุฑุตูุฏ:**
```javascript
// ุฎุตู ุนุฏุฏ ุงูุบุฑู ุงููุญุฌูุฒุฉ ูู availableRooms
await Room.findByIdAndUpdate(room, {
  $inc: { 'availability.availableRooms': -roomCount }
});
```

**ูุซุงู:**
- ูุจู ุงูุญุฌุฒ: `availableRooms = 7`
- ุงูุญุฌุฒ: `roomCount = 2`
- ุจุนุฏ ุงูุญุฌุฒ: `availableRooms = 7 - 2 = 5`

---

### 2. ุนูุฏ ูุญุต ุงูุชููุฑ (`checkRoomAvailability`)

**ุงููููุน:** `backend/controllers/roomController.js` - ุงูุณุทุฑ 397-468

```javascript
// ููุณ ุงูููุทู ุงูุณุงุจู:
// 1. ุงูุจุญุซ ุนู ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ
// 2. ุญุณุงุจ bookedRooms
// 3. ุญุณุงุจ availableRooms = room.availability.availableRooms - bookedRooms
// 4. ุงูุชุญูู: availableRooms >= roomCount
```

---

### 3. ุนูุฏ ุฅูุบุงุก ุงูุญุฌุฒ ุฃู ุชุณุฌูู ุงููุบุงุฏุฑุฉ

**ุฃ) ุฅูุบุงุก ุงูุญุฌุฒ (`cancelBooking`):**
```javascript
// ุฅุฑุฌุงุน ุงูุบุฑู ููุฑุตูุฏ
await Room.findByIdAndUpdate(booking.room, {
  $inc: { 'availability.availableRooms': booking.bookingDetails.roomCount }
});
```

**ุจ) ุชุณุฌูู ุงููุบุงุฏุฑุฉ (`checkOut`):**
```javascript
// ุฅุฑุฌุงุน ุงูุบุฑู ููุฑุตูุฏ
await Room.findByIdAndUpdate(booking.room, {
  $inc: { 'availability.availableRooms': booking.bookingDetails.roomCount }
});
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุงูุญุฌูุฒุงุช ุงูุชู ูุชู ุญุณุงุจูุง:
- ููุท ุงูุญุฌูุฒุงุช ุจุญุงูุฉ `confirmed` ุฃู `checked_in`
- ุงูุญุฌูุฒุงุช `pending` ุฃู `cancelled` ูุง ุชูุญุณุจ

### 2. ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ:
- ูุชู ุงูุจุญุซ ุนู ุงูุญุฌูุฒุงุช ุงูุชู ุชุชุฏุงุฎู ูุน ุงููุชุฑุฉ ุงููุทููุจุฉ:
  ```
  checkIn < checkOutDate && checkOut > checkInDate
  ```

### 3. ุงููุดููุฉ ุงููุญุชููุฉ:
- `availableRooms` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฏ ูุง ูุชุทุงุจู ูุน ุงููุงูุน ุฅุฐุง:
  - ุชู ุญุฐู ุญุฌูุฒุงุช ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  - ุชู ุชุนุฏูู `availableRooms` ูุฏููุงู
  - ุญุฏุซ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุฑุตูุฏ

**ุงูุญู:** ุงููุธุงู ูุญุณุจ ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ ูู ุงูููุช ุงููุนููุ ูุฐูู ุญุชู ูู ูุงู `availableRooms` ุบูุฑ ุฏูููุ ุงูุญุณุงุจ ุงููุนูู ูุนุชูุฏ ุนูู ุงูุญุฌูุฒุงุช ุงูููุฌูุฏุฉ.

---

## ๐ ูุซุงู ุนููู

### ุงูุณููุงุฑูู:
- **ุฅุฌูุงูู ุงูุบุฑู:** 10
- **ุงูุบุฑู ุงููุชุงุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:** 7
- **ุงูุญุฌูุฒุงุช ุงูุญุงููุฉ:**
  - ุญุฌุฒ 1: 2 ุบุฑู (1 ููุงูุฑ - 5 ููุงูุฑ) - `confirmed`
  - ุญุฌุฒ 2: 1 ุบุฑูุฉ (3 ููุงูุฑ - 7 ููุงูุฑ) - `confirmed`
  - ุญุฌุฒ 3: 1 ุบุฑูุฉ (10 ููุงูุฑ - 15 ููุงูุฑ) - `confirmed`

### ุนูุฏ ูุญุงููุฉ ุญุฌุฒ ุฌุฏูุฏ:
- **ุงููุชุฑุฉ ุงููุทููุจุฉ:** 4 ููุงูุฑ - 6 ููุงูุฑ
- **ุนุฏุฏ ุงูุบุฑู ุงููุทููุจุฉ:** 2

### ุงูุญุณุงุจ:
1. **ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ:**
   - ุญุฌุฒ 1: ูุชุฏุงุฎู (4-6 ููุงูุฑ ุฏุงุฎู 1-5 ููุงูุฑ) โ 2 ุบุฑู
   - ุญุฌุฒ 2: ูุชุฏุงุฎู (4-6 ููุงูุฑ ุฏุงุฎู 3-7 ููุงูุฑ) โ 1 ุบุฑูุฉ
   - ุญุฌุฒ 3: ุบูุฑ ูุชุฏุงุฎู (10-15 ููุงูุฑ) โ 0
   - **ุฅุฌูุงูู ุงููุญุฌูุฒ:** 2 + 1 = 3 ุบุฑู

2. **ุงููุญุฏุงุช ุงููุชุงุญุฉ ุงููุนููุฉ:**
   - `availableRooms = 7 - 3 = 4 ุบุฑู`

3. **ุงููุชูุฌุฉ:**
   - ุงููุทููุจ: 2 ุบุฑู
   - ุงููุชุงุญ: 4 ุบุฑู
   - โ **ุงูุญุฌุฒ ูููู**

4. **ุจุนุฏ ุงูุญุฌุฒ:**
   - `availableRooms` ูุตุจุญ: `7 - 2 = 5`

---

## ๐ ุงูุฎูุงุตุฉ

**ุงูุญุฌุฒ ูุนุชูุฏ ุนูู:**
1. โ `totalRooms` โ ุฅุฌูุงูู ุงููุญุฏุงุช (ุซุงุจุช)
2. โ `availableRooms` โ ุงููุญุฏุงุช ุงููุชุงุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุชุบูุฑ)
3. โ **ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ** โ ูุชู ุญุณุงุจูุง ูู ุงูููุช ุงููุนูู (ุงูุฃูู!)

**ุงูููุทู:**
```
ุงููุญุฏุงุช ุงููุชุงุญุฉ ุงููุนููุฉ = availableRooms - (ูุฌููุน ุงูุญุฌูุฒุงุช ุงููุชุฏุงุฎูุฉ)
```

**ุงูุญุฌุฒ ูููู ุฅุฐุง:**
```
ุงููุญุฏุงุช ุงููุชุงุญุฉ ุงููุนููุฉ >= ุนุฏุฏ ุงูุบุฑู ุงููุทููุจุฉ
```

